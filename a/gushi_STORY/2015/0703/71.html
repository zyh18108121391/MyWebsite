<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />

<title>小房子-郑银华的专属网站_【学习心得】leancloud query()异步问题决绝方案</title>
<meta name="keywords" content="学习,心得,leancloud,query,异步,问题,决绝" />
<meta name="description" content="在写leancloud云函数或者javascript时，不可避免会对数据表进行查询，会使用query.find()这个函数或着其他异步函数。而且常常会放在for或者while循环中，但是就会遇到一个人问题：总是循环结束以后query函数才执行，这是后索引就不起作用了。这个问题也困扰了" />

<link href="/templets/default/style.css" rel="stylesheet" type="text/css" />
<link href="/templets/default/photostyle.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/templets/default/pic.js"></script>
<script type="text/javascript" src="/templets/default/runphoto.js"></script>
<script type="text/javascript">

function mover_HOME(){
	document.getElementById("HOME").style.marginTop="15px";	
}
function mout_HOME(){
	document.getElementById("HOME").style.marginTop="0px";
}

function mover_STORY(){
	document.getElementById("STORY").style.marginTop="15px";	
}
function mout_STORY(){
	document.getElementById("STORY").style.marginTop="0px";
}

function mover_PHOTO(){
	document.getElementById("PHOTO").style.marginTop="15px";	
}
function mout_PHOTO(){
	document.getElementById("PHOTO").style.marginTop="0px";
}

function mover_VIDEO(){
	document.getElementById("VIDEO").style.marginTop="15px";	
}
function mout_VIDEO(){
	document.getElementById("VIDEO").style.marginTop="0px";
}

function mover_ABOUT(){
	document.getElementById("ABOUT").style.marginTop="15px";	
}
function mout_ABOUT(){
	document.getElementById("ABOUT").style.marginTop="0px";
}
</script>

</head>

<body>
<div class="bd">

<link rel="shortcut icon" href="favicon.ico" />
<!--头部开始-->
<div id="head">
	<!--悬浮模块-->	
	<div id="float_dh">
		<div id="Photos_dh">
		<a href="/a/3Dxiangce/" title="进入3D相册">3D相册</a>
		</div>
		
		<div id="Messages_dh">
		<a href="/a/liuyanqiang/" title="进入留言墙">留言墙</a>
		</div>
	</div>
	<div id="float_fx">
		<script type="text/javascript" src="/templets/default/js/qqfx.js"></script>
		<script src="http://qzonestyle.gtimg.cn/qzone/app/qzlike/qzopensl.js#jsdate=20111201" charset="utf-8"></script>
	</div>
	<!--悬浮模块结束-->	
	
		<div id="left"><a class="log" href="/"></a></div>
		<div  id="log_words">小房子-这里属于郑银华的另一片内心世界！</div>
		<div id="dh_list">
		<ul>
			<li id="HOME" onmouseover="mover_HOME()" onmouseout="mout_HOME()" class="button dh"><a href="/"><div class="li-a1">主页</div><div class="li-a2">HOME</div></a></li>			
			<li id="STORY" onmouseover="mover_STORY()" onmouseout="mout_STORY()"  class="button dh"><a href="/a/gushi_STORY/"><div class="li-a1">故事</div><div class="li-a2">STORY</div></a></li>
			<li id="PHOTO" onmouseover="mover_PHOTO()" onmouseout="mout_PHOTO()" class="button dh"><a href="/a/xiangce_PHOTO/"><div class="li-a1">相册</div><div class="li-a2">PHOTO </div></a></li>
			<li id="VIDEO" onmouseover="mover_VIDEO()" onmouseout="mout_VIDEO()" class="button dh"><a href="/a/shipin_VIDEO/"><div class="li-a1">视频</div><div class="li-a2">VIDEO</div></a></li>
			<li id="ABOUT" onmouseover="mover_ABOUT()" onmouseout="mout_ABOUT()" class="button dh"><a href="/a/guanyu_ABOUT/"><div class="li-a1">关于</div><div class="li-a2">ABOUT</div></a></li>
		</ul>
		</div>
  </div>
  <div id="hr"></div>
  <!--头部结束-->

  <div id="content">
  	<div id="article_content">
	
		<div id="article_left">
			<div id="NewStory">
				<div id="header">
				<span id="head_left">最新动态-NEW STORY</span>
				</div>
				<div id="article_news">
					<ul>
						<li><a href="/a/gushi_STORY/2015/0703/71.html" title="【学习心得】leancloud query()">【学习心得】leancloud query()...</a></li>
<li><a href="/a/gushi_STORY/2015/0702/70.html" title="【网站日志】网站又再一次被黑，">【网站日志】网站又再一次被黑，...</a></li>
<li><a href="/a/gushi_STORY/2015/0605/69.html" title="【学习心得】如何在网站中添加QQ">【学习心得】如何在网站中添加QQ...</a></li>
<li><a href="/a/gushi_STORY/2015/0603/68.html" title="【学习心得】dedecms 如何调用栏">【学习心得】dedecms 如何调用栏...</a></li>
<li><a href="/a/xiangce_PHOTO/2015/0602/67.html" title="【游戏人生】最爱LOL德莱文金牌">【游戏人生】最爱LOL德莱文金牌...</a></li>

					</ul>
				</div>
			</div>
			<div id="RecommendImg">
				<div id="header">
				<span id="head_left">推荐图文-RECOMMENT PHOTO </span>
				<span id="head_right"><a href="/a/xiangce_PHOTO/">MORE+</a></span>
				</div>
				<div id="article_imgs">
					<ul>
						<li><a href="/a/xiangce_PHOTO/2015/0602/67.html" title="【游戏人生】最爱LOL德莱文金牌"><img src='/uploads/allimg/150602/1-150602162SDJ.png' border='0' width='120' height='120' alt='【游戏人生】最爱LOL德莱文金牌主播'></a></li>
<li><a href="/a/xiangce_PHOTO/2015/0302/51.html" title="七中合照-海内存知己天涯若比邻"><img src='/uploads/allimg/150302/1-1503021H126.jpg' border='0' width='120' height='120' alt='七中合照-海内存知己天涯若比邻'></a></li>
<li><a href="/a/xiangce_PHOTO/2015/0302/50.html" title="儿时回忆-转盘画糖你可吃过"><img src='/uploads/allimg/150302/1-1503021G005.jpg' border='0' width='120' height='120' alt='儿时回忆-转盘画糖你可吃过'></a></li>
<li><a href="/a/xiangce_PHOTO/2015/0201/39.html" title="最佳缘分-三人同年同月同日生"><img src='/uploads/allimg/150201/1-150201201000-lp.jpg' border='0' width='120' height='120' alt='最佳缘分-三人同年同月同日生'></a></li>

					</ul>
				</div>
			</div>
		</div><!--article_left end-->
		
		<div id="article_right">
			<div id="header">
				<span id="head_left">>>当前位置:<a href='http://localhost//'></a> > <a href='/a/gushi_STORY/'>故事-STORY</a> > </span>
			</div>
			<div id="article_abody">
			<div id="article_title">【学习心得】leancloud query()异步问题决绝方案</div>
			<div id="article_timeandmore">点击数：<strong style="color:#CCCCCC"><script src="/plus/count.php?view=yes&aid=71&mid=1" type='text/javascript' language="javascript"></script></strong>次 更新时间：<strong style="color:#CCCCCC">2015-07-03 16:54</strong></div>
			<div id="article_bodyContent">
			在写leancloud云函数或者javascript时，不可避免会对数据表进行查询，会使用query.find()这个函数或着其他异步函数。而且常常会放在for或者while循环中，但是就会遇到一个人问题：总是循环结束以后query函数才执行，这是后索引就不起作用了。这个问题也困扰了我好久。下面介绍如何解决这个问题。<br />
例子代码如下：<br />
<div>
	for (var i = 0; i &lt; list.length; i++) {</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var sku=list[i];</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console.log(&quot;开始查询&quot; + sku.get(&quot;skuName&quot;) + &quot;的进货信息&quot;);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var PurQuery = new AV.Query(Purchases);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PurQuery.equalTo(&quot;store&quot;, curTerminalStore);//注意，这里要传入对象，而不是objectId</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PurQuery.equalTo(&quot;sku&quot;,sku);&nbsp;</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PurQuery.descending(&quot;date&quot;);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PurQuery.limit(1);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PurQuery.find({ &nbsp; / &nbsp;/内层开始</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success: function(results) {</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(results.length){</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var object = results[0];</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var resultObject = {};</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; var curSku = object.get(&quot;sku&quot;);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; curSku.fetch({</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success: function(fetchedSku) {//由于外层循环中sku对象在不断变化，所以这里反过来从查询出的Purchases对象中反查准确的sku</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resultObject.PurObject = fetchedSku;</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resultObject.Purcount = object.get(&quot;count&quot;);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resultObject.PurDate = object.get(&quot;date&quot;);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; console.log(&quot;最新进货&quot; + resultObject.Purcount);&nbsp;</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resultArray.push([resultObject]);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(++completeCount &gt;= list.length){//所有SKU都处理完毕即可应答了</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; response.success(resultArray); &nbsp; &nbsp;</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }else{</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; completeCount++;//没有库存数据的SKU不加入列表，只计数</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error: function(error) {</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; alert(&quot;Error: &quot; + error.code + &quot; &quot; + error.message);</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resultObject.Purcount = -1;</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; resultObject.PurDate = -1;</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });</div>
<div>
	&nbsp; &nbsp; &nbsp; &nbsp; }<br />
	上述代码中，最重要的解决方案就是在内层中反向获取当前查询结果，找到准确的变量（索引）图中就是sku。对于那种外层索引对内层毫无影响，只是单纯的循环来说，可以不需要反向查询。<br />
	<br />
	<strong>获取更多技术心得文章：&nbsp;</strong><br />
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
	&nbsp; &nbsp; &nbsp; &nbsp;<a href="http://www.zhengyinhua.com/a/gushi_STORY/2015/0408/60.html">【学习笔记】leancloud中&nbsp;javascript遇到的问题和解决方案</a><br />
	&nbsp; &nbsp; &nbsp;<br />
	&nbsp; &nbsp; &nbsp;&nbsp;<a href="http://www.zhengyinhua.com/a/gushi_STORY/2015/0702/70.html">【网站日志】网站又再一次被黑，真是日了dog了，安全度是该提高</a><br />
	&nbsp; &nbsp; &nbsp;&nbsp;<br />
	小房子-郑银华的专属网站、一个温馨的世界，一颗温暖的内心。<br />
	&nbsp;</div>

			</div>
			<div class="context">
				<ul>
					<li>上一篇：<a href='/a/gushi_STORY/2015/0702/70.html'>【网站日志】网站又再一次被黑，真是日了dog了，安全度是该提高</a> </li>
					<li>下一篇：没有了 </li>
				</ul>
			</div><!-- /context -->
			</div>
	
		</div><!--article_right end-->
	</div>
	
  </div><!--content end-->
  <div class="clear"></div>
<!---尾部开始---->
	<div id="hr2"></div>
	<div id="footer">
	<div class="center">
	<div id="footer_img"><a href="/" title="小房子-郑银华的专属网站"><img src="/templets/default/images/logfooter.png" /></a></div>
		<div id="footer_copy">
		<div class="footer_word">小房子</div>
			<ul>
				<li>联系电话：18108121391</li>
				<li><span class="qqtalk">QQ交谈:</span><span class="qqtalkimg"><a target="_blank" href="http://wpa.qq.com/msgrd?v=3&uin=390579684&site=qq&menu=yes"><img border="0" src="http://wpa.qq.com/pa?p=2:390579684:51" alt="点击这里给我QQ交谈" title="点击这里给我QQ交谈"/></a></span></li>
				<div class="clear"></div>
				<li><a href="/a/liuyanqiang/">给我留言<img src="/templets/default/images/messages.png"  width="20px" height="20px"/></a></li>
				<li>@2014-2015 版权所有</li>
			</ul>
		</div>
		<div id="footer_dh">
		<div class="footer_word">相关链接</div>
			<ul>
				<li><a href="/a/gushi_STORY/">故事-STORY</a></li>
				<li><a href="/a/xiangce_PHOTO/">相册-PHOTO</a></li>
				<li><a href="/a/shipin_VIDEO/">视频-VIDEO</a></li>
				<li><a href="/a/guanyu_ABOUT/">关于-ABOUT</a></li>
			</ul>
		</div>
		</div>
	</div>
<!--尾部结束-->
	
  </div>
</body>
</html>
